{
    "version": "7.2.4.170995",
    "description": "Powerful x86 and AMD64/Intel64 virtualization product for enterprise as well as home use.",
    "homepage": "https://www.virtualbox.org/",
    "license": {
        "identifier": "GPL-2.0-only|Freeware",
        "url": "https://www.virtualbox.org/wiki/VirtualBox_PUEL"
    },
    "notes": [
        "The VirtualBox Extension Pack is only free for personal, educational or evaluation use.",
        "A license must be purchased for enterprise use.",
        "For more information, go here: https://www.virtualbox.org/wiki/Licensing_FAQ"
    ],
    "depends": "extras/vcredist2022",
    "architecture": {
        "64bit": {
            "url": [
                "https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4-170995-Win.exe#/setup.exe",
                "https://download.virtualbox.org/virtualbox/7.2.4/Oracle_VirtualBox_Extension_Pack-7.2.4-170995.vbox-extpack"
            ],
            "hash": [
                "22988be9792f39c8e07068504612bd83aae8f8317e2aaf7515079f5cd9421675",
                "b80ee54252442ec025d6a7b2b9c3f32526ab5c2d91a0ffa2385be3ed83bcff0b"
            ]
        }
    },
    "pre_install": [
        "if (!(is_admin)) { error \"$app requires admin rights to $cmd\"; break }",
        "$succ = Invoke-ExternalCommand \"$dir\\setup.exe\" -ArgumentList @('-extract', '-path', \"$dir\", '-silent')",
        "if(-not $succ) { error \"Failed ($succ) to unpack `\"$dir\\setup.exe`\"\" ; break }",
        "Remove-Item \"$dir\\setup.exe\""
    ],
    "installer": {
        "script": [
            "$setup = Get-ChildItem \"$dir\\VirtualBox*_amd64.msi\" | Select-Object -First 1",
            "if (-not $setup) { error \"MSI not found under $dir\"; break }",
            "$args = @('/i', \"$($setup.FullName)\", '/qn', '/norestart', '/log', \"$dir\\install-log.txt\", 'VBOX_INSTALLDESKTOPSHORTCUT=0', 'VBOX_INSTALLQUICKLAUNCHSHORTCUT=0', 'VBOX_START=0', 'VBOX_INSTALLSTARTMENUENTRIES=0')",
            "if (!$global) { $args += 'ALLUSERS=2', \"INSTALLDIR=`\"$dir`\"\" }",
            "if ($global) { $args += 'ALLUSERS=1' }",
            "$succ = Invoke-ExternalCommand msiexec -ArgumentList $args",
            "Remove-Item -Path @(\"$dir\\VirtualBox-*64.msi\", \"$dir\\common.cab\")",
            "if (-not $succ) {",
            "   Select-String -Path \"$dir\\install-log.txt\" -Pattern 'MSI \\(.*' | ForEach-Object { warn \"from log:`n    $_\" }",
            "   error \"Failed ($succ) to install `\"$($setup.FullName)`\".`nLog file: `\"$dir\\install-log.txt`\"\"",
            "   break",
            "}"
        ]
    },
    "post_install": [
        "if ($global) { $installDir =  \"$env:ProgramW6432\\Oracle\\VirtualBox\" } else { $installDir = \"$original_dir\" }",
        "Invoke-ExternalCommand icacls -ArgumentList @( \"$installDir\", \"/reset\" ) -Quiet | Out-Null",
        "startmenu_shortcut \"$installDir\\VirtualBox.exe\" 'VirtualBox' $null $null $global",
        "Get-ChildItem -Path \"$installDir\" -Filter '*.exe' | ForEach-Object {",
        "   info \"Adding shim '$($_.BaseName)'\"",
        "   shim \"$($_.FullName)\" $global \"$($_.BaseName)\"",
        "}",
        "$extpack = Get-ChildItem -Path \"$dir\" -Filter 'Oracle_VirtualBox_Extension_Pack-*.vbox-extpack' | Select-Object -First 1",
        "if (-not $extpack) { error \"Extension pack not found under $dir\"; break }",
        "Invoke-ExternalCommand tar -Activity 'Extracting License' -ArgumentList @('-xzf', \"$($extpack.FullName)\", '-C', \"$dir\", './ExtPack-license.txt') | Out-Null",
        "$exthash = $(Get-FileHash -Path \"$dir\\ExtPack-license.txt\" -Algorithm SHA256).Hash",
        "Remove-Item \"$dir\\ExtPack-license.txt\"",
        "Invoke-ExternalCommand VBoxManage -Activity 'Installing Oracle VirtualBox Extension Pack' -ArgumentList @('extpack', 'install', \"--accept-license=$exthash\", \"$($extpack.FullName)\") -LogPath \"$dir\\install-log-extpack.txt\" | Out-Null",
        "Remove-Item \"$($extpack.FullName)\"",
        "info \"Guest additions are located at: '$installDir\\VBoxGuestAdditions.iso'\""
    ],
    "pre_uninstall": [
        "if (!(is_admin)) { error \"$app requires admin rights to $cmd\"; break }",
        "Remove-Item \"$(shortcut_folder $global)\\VirtualBox.lnk\" -ErrorAction SilentlyContinue",
        "if ($global) { $installDir = \"$env:ProgramW6432\\Oracle\\VirtualBox\" } else { $installDir = \"$original_dir\" }",
        "Invoke-ExternalCommand VBoxManage -Activity 'Uninstalling Oracle VirtualBox Extension Pack' -ArgumentList @('extpack', 'uninstall', 'Oracle VirtualBox Extension Pack') -LogPath \"$dir\\uninstall-log-extpack.txt\" | Out-Null",
        "Remove-Item \"$installDir\\ExtensionPacks\" -ErrorAction SilentlyContinue",
        "Get-ChildItem -Path \"$installDir\" -Filter '*.exe' | Select-Object -ExpandProperty BaseName | ForEach-Object { rm_shim \"$_\" \"$(shimdir $global)\" }"
    ],
    "uninstaller": {
        "script": [
            "$idnum = Get-CimInstance Win32_Product | Where-Object { $_.Name -match 'Oracle VirtualBox [\\d\\.]+' } | Select-Object -ExpandProperty IdentifyingNumber",
            "if (!$idnum) { error \"Could not find uninstaller for: Oracle VirtualBox\" }",
            "else {",
            "   $succ = Invoke-ExternalCommand msiexec -ArgumentList @('/x', \"$idnum\", '/qn', '/norestart', '/log', \"$dir\\uninstall-log.txt\")",
            "   if(-not $succ) { error \"Failed ($succ) to uninstall `nLog file: `\"$dir\\uninstall-log.txt`\"\" }",
            "}"
        ]
    },
    "checkver": {
        "url": "https://www.virtualbox.org/wiki/Downloads",
        "regex": "VirtualBox-(?<version>[\\d.]+)-(?<build>[\\d]+)-Win.exe",
        "replace": "${version}.${build}"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": [
                    "https://download.virtualbox.org/virtualbox/$matchHead/VirtualBox-$matchHead-$buildVersion-Win.exe#/setup.exe",
                    "https://download.virtualbox.org/virtualbox/$matchHead/Oracle_VirtualBox_Extension_Pack-$matchHead-$buildVersion.vbox-extpack"
                ]
            }
        },
        "hash": {
            "url": "https://download.virtualbox.org/virtualbox/$matchHead/SHA256SUMS"
        }
    }
}

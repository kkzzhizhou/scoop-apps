{
    "version": "2020-05-01T11.46.43",
    "description": "A Spicetify custom app that fetches lyrics for Spotify.",
    "homepage": "https://github.com/khanhas/genius-spicetify",
    "license": "Freeware",
    "depends": "spicetify-cli",
    "url": "https://github.com/khanhas/genius-spicetify/archive/master.zip",
    "hash": "f06cf23a83dc248c697cc16627dbcf300e6d9547ac66cc29aaef188c4b6a4eed",
    "notes": "See here to configure a Musixmatch user token: https://github.com/khanhas/genius-spicetify#musicxmatch",
    "installer": {
        "script": [
            "$spotify_path = scoop which Spotify",
            "",
            "if (-not $spotify_path) {",
            "    $spotify_path = \"$env:APPDATA\\Spotify\\Spotify.exe\"",
            "",
            "    if (-not (Test-Path $spotify_path)) {",
            "        Write-Host \"Spotify must be installed to install $app.\" -Foreground Red",
            "        exit 1",
            "    }",
            "}",
            "",
            "# TODO persist Musixmatch token",
            "Remove-Item -ErrorAction Ignore -Recurse \"$env:USERPROFILE\\.spicetify\\CustomApps\\genius\"",
            "Copy-Item -Recurse \"$dir\\genius-spicetify-master\" -Destination \"$env:USERPROFILE\\.spicetify\\CustomApps\\genius\"",
            "",
            "if (-not (Test-Path \"$env:APPDATA\\Spotify\\prefs\")) {",
            "    # spicetify-cli refuses to apply without a backup, and spicetify-cli needs a prefs file so it can tell which version of Spotify is currently installed",
            "    $spotify_version = (Select-String -Path $spotify_path -Pattern '\\d\\.\\d\\.\\d+\\.\\d+\\.[a-z1-9]+' | Select-Object -First 1).Matches[0].Groups[0].Value",
            "    New-Item -ItemType Directory -Force -Path \"$env:APPDATA\\Spotify\" | Out-Null",
            "    Set-Content \"$env:APPDATA\\Spotify\\prefs\" \"app.last-launched-version=`\"$spotify_version`\"\"",
            "}",
            "",
            "$spotify_running = Get-Process Spotify -ErrorAction SilentlyContinue",
            "Stop-Process -Name Spotify",
            "",
            "spicetify config spotify_path \"$(Split-Path $spotify_path)\" --quiet",
            "spicetify config custom_apps genius --quiet",
            "",
            "spicetify restore backup apply --quiet --no-restart",
            "",
            "$spotify_dir = \"$(appdir spotify-latest)\\current\"",
            "$blockthespot_dir = \"$(appdir blockthespot)\\current\"",
            "",
            "if ((Test-Path \"$spotify_dir\") -and (Test-Path \"$blockthespot_dir\")) {",
            "    Move-Item -Force \"$spotify_dir\\chrome_elf.dll\" -Destination \"$spotify_dir\\chrome_elf.dll.original\"",
            "    Copy-Item \"$blockthespot_dir\\chrome_elf.dll\" -Destination \"$spotify_dir\"",
            "    if (-not (Get-Content -ErrorAction Ignore \"$spotify_dir\\config.ini\")) { Copy-Item \"$blockthespot_dir\\config.ini\" -Destination \"$spotify_dir\" }",
            "}",
            "",
            "if ($spotify_running) {",
            "   & \"$spotify_path\"",
            "}"
        ]
    },
    "uninstaller": {
        "script": [
            "Remove-Item -Recurse -ErrorAction Ignore \"$env:USERPROFILE\\.spicetify\\CustomApps\\genius\"",
            "",
            "$spotify_running = Get-Process Spotify -ErrorAction SilentlyContinue",
            "Stop-Process -Name Spotify",
            "",
            "$spicetify_config = \"$env:USERPROFILE\\.spicetify\\config.ini\"",
            "",
            "if (Test-Path \"$spicetify_config\") {",
            "    $content = (Get-Content \"$spicetify_config\") -replace '(custom_apps.*)genius\\|?(.*)', '$1$2'",
            "    [System.IO.File]::WriteAllLines($spicetify_config, $content) # UTF-8 no BOM is required",
            "}",
            "",
            "spicetify restore backup apply --quiet --no-restart",
            "",
            "$spotify_dir = \"$(appdir spotify-latest)\\current\"",
            "$blockthespot_dir = \"$(appdir blockthespot)\\current\"",
            "",
            "if ((Test-Path \"$spotify_dir\") -and (Test-Path \"$blockthespot_dir\")) {",
            "    Move-Item -Force \"$spotify_dir\\chrome_elf.dll\" -Destination \"$spotify_dir\\chrome_elf.dll.original\"",
            "    Copy-Item \"$blockthespot_dir\\chrome_elf.dll\" -Destination \"$spotify_dir\"",
            "    if (-not (Get-Content -ErrorAction Ignore \"$spotify_dir\\config.ini\")) { Copy-Item \"$blockthespot_dir\\config.ini\" -Destination \"$spotify_dir\" }",
            "}",
            "",
            "if ($spotify_running) {",
            "   & \"$(scoop which Spotify)\"",
            "}"
        ]
    },
    "checkver": {
        "url": "https://api.github.com/repos/khanhas/genius-spicetify/commits",
        "regex": "([\\d-]+T)(\\d+):(\\d+):(\\d+)",
        "replace": "$1$2.$3.$4"
    },
    "autoupdate": {
        "url": "https://github.com/khanhas/genius-spicetify/archive/master.zip"
    }
}

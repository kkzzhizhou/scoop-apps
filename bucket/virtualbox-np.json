{
    "version": "7.2.6.172322",
    "description": "Powerful x86 and AMD64/Intel64 virtualization product for enterprise as well as home use.",
    "homepage": "https://www.virtualbox.org/",
    "license": "GPL-2.0-only",
    "depends": "extras/vcredist2022",
    "architecture": {
        "64bit": {
            "url": "https://download.virtualbox.org/virtualbox/7.2.6/VirtualBox-7.2.6-172322-Win.exe#/setup.exe",
            "hash": "5194a1695d1b4c07d129e2b1e2088adc3dd2f1f0f73699004375d6dfdfa60fd7"
        }
    },
    "pre_install": [
        "if (!(is_admin)) { error \"$app requires admin rights to $cmd\"; break }",
        "$succ = Invoke-ExternalCommand \"$dir\\setup.exe\" -ArgumentList @('-extract', '-path', \"$dir\", '-silent')",
        "if(-not $succ) { error \"Failed ($succ) to unpack `\"$dir\\setup.exe`\"\" ; break }",
        "Remove-Item \"$dir\\setup.exe\""
    ],
    "installer": {
        "script": [
            "$setup = Get-ChildItem -Path \"$dir\" -Filter 'VirtualBox-*.msi' | Select-Object -First 1",
            "if (-not $setup) { error \"MSI not found under $dir\"; break }",
            "$args = @('/i', \"$($setup.FullName)\", '/qn', '/norestart', '/log', \"$dir\\install-log.txt\", 'VBOX_INSTALLDESKTOPSHORTCUT=0', 'VBOX_INSTALLQUICKLAUNCHSHORTCUT=0', 'VBOX_START=0', 'VBOX_INSTALLSTARTMENUENTRIES=0')",
            "if (!$global) { $args += 'ALLUSERS=2', \"INSTALLDIR=`\"$dir`\"\" }",
            "if ($global) { $args += 'ALLUSERS=1' }",
            "$succ = Invoke-ExternalCommand msiexec -ArgumentList $args",
            "Get-ChildItem -Path \"$dir\" -Filter 'VirtualBox-*.msi' | Remove-Item",
            "Get-ChildItem -Path \"$dir\" -Filter 'common.cab' | Remove-Item",
            "if (-not $succ) {",
            "   Select-String -Path \"$dir\\install-log.txt\" -Pattern 'MSI \\(.*' | ForEach-Object { warn \"from log:`n    $_\" }",
            "   error \"Failed ($succ) to install `\"$($setup.FullName)`\".`nLog file: `\"$dir\\install-log.txt`\"\"",
            "   break",
            "}"
        ]
    },
    "post_install": [
        "if ($global) { $installDir =  \"$env:ProgramW6432\\Oracle\\VirtualBox\" } else { $installDir = \"$original_dir\" }",
        "Invoke-ExternalCommand icacls -ArgumentList @( \"$installDir\", \"/reset\" ) -Quiet | Out-Null",
        "startmenu_shortcut \"$installDir\\VirtualBox.exe\" 'VirtualBox' $null $null $global",
        "Get-ChildItem -Path \"$installDir\" -Filter '*.exe' | ForEach-Object {",
        "   info \"Adding shim '$($_.BaseName)'\"",
        "   shim \"$($_.FullName)\" $global \"$($_.BaseName)\"",
        "}"
    ],
    "pre_uninstall": [
        "if (!(is_admin)) { error \"$app requires admin rights to $cmd\"; break }",
        "Remove-Item \"$(shortcut_folder $global)\\VirtualBox.lnk\" -ErrorAction SilentlyContinue",
        "if ($global) { $installDir = \"$env:ProgramW6432\\Oracle\\VirtualBox\" } else { $installDir = \"$original_dir\" }",
        "Get-ChildItem -Path \"$installDir\" -Filter '*.exe' | Select-Object -ExpandProperty BaseName | ForEach-Object { rm_shim \"$_\" \"$(shimdir $global)\" }"
    ],
    "uninstaller": {
        "script": [
            "$idnum = Get-CimInstance Win32_Product | Where-Object { $_.Name -match 'Oracle VirtualBox [\\d\\.]+' } | Select-Object -ExpandProperty IdentifyingNumber",
            "if (!$idnum) { error \"Could not find uninstaller for: Oracle VirtualBox\" }",
            "else {",
            "   $succ = Invoke-ExternalCommand msiexec -ArgumentList @('/x', \"$idnum\", '/qn', '/norestart', '/log', \"$dir\\uninstall-log.txt\")",
            "   if(-not $succ) { error \"Failed ($succ) to uninstall `nLog file: `\"$dir\\uninstall-log.txt`\"\" }",
            "}"
        ]
    },
    "checkver": {
        "url": "https://www.virtualbox.org/wiki/Downloads",
        "regex": "VirtualBox-(?<version>[\\d.]+)-(?<build>[\\d]+)-Win.exe",
        "replace": "${version}.${build}"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "https://download.virtualbox.org/virtualbox/$matchHead/VirtualBox-$matchHead-$buildVersion-Win.exe#/setup.exe"
            }
        },
        "hash": {
            "url": "https://download.virtualbox.org/virtualbox/$matchHead/SHA256SUMS"
        }
    }
}
